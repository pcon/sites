<html>
<head>
	<title>Karma</title>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/blitzer/jquery-ui.css" />

	<style>
		#widget_wrapper {
			margin: 0 auto;
			width: 525px;
		}

		#chart_div {
			margin: 0 auto;
		}

		.ui-autocomplete {
			max-height: 100px;
			overflow-y: auto;
			/* prevent horizontal scrollbar */
			overflow-x: hidden;
		}
		/* IE 6 doesn't support max-height
		* we use height instead, but this forces the menu to always be this tall
		*/
		* html .ui-autocomplete {
			height: 100px;
		}

		.ui-widget {
			display: inline-block;
		}

		.ui-widget input {
			border: 1px solid #ddd;
			padding: 0px 5px;
			width: 150px;
		}
	</style>

	<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		var TODAY = new Date();
		var START_DATE = '2012-10-26';
		var END_DATE = ''+TODAY.getFullYear()+'-'+(TODAY.getMonth()+1)+'-'+TODAY.getDate();

		var username = null;
		var names = null;

		var firstDay = null;
		var firstDate = null;
		var lastDay = null;
		var lastDate = null;

		var fromDay = null;
		var fromDate = null;
		var toDay = null;
		var toDate = null;

		google.load("visualization", "1", {packages:["corechart"]});
		google.setOnLoadCallback(fetchKarma);

		var QueryString = function () {
			// This function is anonymous, is executed immediately and 
			// the return value is assigned to QueryString!
			var query_string = {};
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
					// If first entry with this name
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = pair[1];
					// If second entry with this name
				} else if (typeof query_string[pair[0]] === "string") {
					var arr = [ query_string[pair[0]], pair[1] ];
					query_string[pair[0]] = arr;
					// If third or later entry with this name
				} else {
					query_string[pair[0]].push(pair[1]);
				}
			} 
			return query_string;
		} ();

		function fetchKarma() {
			if (fromDay == null && QueryString.from != undefined) {
				fromDay = QueryString.from;
				fromDate = Date.parse(fromDay);
			}

			if (toDay == null && QueryString.to != undefined) {
				toDay = QueryString.to;
				toDate = Date.parse(toDay);
			}

			var url = 'http://db.deadlypenguin.com/karma/_all_docs?include_docs=true';

			if (fromDay != null) {
				url += '&startkey="'+fromDay+'"';
			}

			if (toDay != null) {
				url += '&endkey="'+toDay+'"';
			}

			showLoadingDialog();
			jQuery.ajax({
				url: url,
				dataType: 'jsonp',
				success: buildDataSet
			});
		}

		function updateUrl(currNick, curFromDay, curToDay) {
			var newUrl = document.URL.substr(0, document.URL.lastIndexOf('/')+1);
			newUrl += '?nick='+currNick+'&from='+curFromDay+'&to='+curToDay;
			window.history.pushState({}, "", newUrl);
		}

		function selectedNick(i, item) {
			username = item.item.label;
			updateUrl(window.username, window.fromDay, window.toDay);
			jQuery('#nicks').val('');
			fetchKarma();
		}

		function showLoadingDialog() {
			jQuery('#dialog').dialog({modal: true});
			jQuery('#dialog').dialog("open");
		}

		function hideLoadingDialog() {
			jQuery('#dialog').dialog("close");
		}

		function buildDataSet(data) {
			if (window.username == null && QueryString.nick != undefined) {
				username = QueryString.nick;
			} else if (window.username == null) {
				username = 'oorgle';
			}

			jQuery('#nicks').val(username);

			var myArray = [
				['Date', ''+username],
			];

			if (lastDay == null) {
				var item = data.rows[data.rows.length-1];
				lastDay = item.id;
				lastDate = Date.parse(lastDay);

				if (toDay == null) {
					toDay = lastDay;
					toDate = lastDate;
				}
			}


			jQuery.each(data.rows, function(i, item) {
				if (firstDay == null) {
					firstDay = item.id;
					firstDate = Date.parse(firstDay);

					if (fromDay == null) {
						fromDay = firstDay;
						fromDate = firstDate;
					}
				}

				if (lastDay == null && i + 1 == data.rows.length) {
					lastDay = item.id;
					lastDate = Date.parse(lastDay);

					if (toDay == null) {
						toDay = lastDay;
						toDate = lastDate;
					}
				}

				if (names == null && i + 1 == data.rows.length) {
					names = new Array();
					for (var key in item.doc.scores[0]) {
						names.push(key);
					}

					jQuery('#nicks').autocomplete({
						source: names,
						select: selectedNick
					});
				}

				var itemDate = Date.parse(item.id);

				if (itemDate >= fromDate && itemDate <= toDate) {
					var row = [''+item.id, Number(item.doc.scores[0][username])];
					myArray.push(row);
				}
			});

			jQuery("#from").datepicker({
				dateFormat: "yy-mm-dd",
				defaultDate: fromDay,
				minDate: START_DATE,
				maxDate: lastDay,
				changeMonth: true,
				numberOfMonths: 3,
				onClose: function( selectedDate ) {
					jQuery("#to").datepicker( "option", "minDate", selectedDate );
					fromDay = selectedDate;
					fromDate = Date.parse(fromDay);
					updateUrl(window.username, window.fromDay, window.toDay);
					fetchKarma();
				}
			}).val(fromDay);

			jQuery("#to").datepicker({
				dateFormat: "yy-mm-dd",
				defaultDate: toDay,
				minDate: firstDay,
				maxDate: END_DATE,
				changeMonth: true,
				numberOfMonths: 3,
				onClose: function( selectedDate ) {
					jQuery("#from").datepicker( "option", "maxDate", selectedDate );
					toDay = selectedDate;
					toDate = Date.parse(toDay);
					updateUrl(window.username, window.fromDay, window.toDay);
					fetchKarma();
				}
			}).val(toDay);

			drawChart(myArray);
		}

		function drawChart(arrayData) {
			var data = google.visualization.arrayToDataTable(arrayData);

			var options = {
				title: 'Karma'
			};

			var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
			chart.draw(data, options);
			hideLoadingDialog();
		}
	</script>
</head>
<body>
	<div id="widget_wrapper">
		<div class="ui-widget">
			<input type="text" id="nicks" name="nicks" />
		</div>
		<div class="ui-widget">
			<label for="from">from</label>
			<input type="text" id="from" name="from" />
		</div>
		<div class="ui-widget">
			<label for="to">to</label>
			<input type="text" id="to" name="to" />
		</div>
	</div>
	<div id="chart_div" style="width: 900px; height: 500px;"></div>
	<div id="dialog" title="Loading Karma Graph">Loading the karma graph</div>
</div>
</body>
</html>